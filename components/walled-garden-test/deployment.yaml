# Walled Garden → Authenticated Flow Test
# Demonstrates: Unknown subscriber → Walled Garden → Activation → Real IP
#
# Architecture:
# ┌─────────────────────────────────────────────────────────────────────┐
# │                    demo-walled-garden namespace                      │
# │                                                                      │
# │  ┌──────────┐       ┌──────────────────────────────────────────┐   │
# │  │  Nexus   │◄─────►│           Pod: bng-wgar-test              │   │
# │  │  Server  │ HTTP  │                                           │   │
# │  │          │       │  ┌────────┐  veth   ┌──────────────────┐ │   │
# │  │ Pools:   │       │  │ Client │◄───────►│       BNG        │ │   │
# │  │ - wgar   │       │  │(udhcpc)│         │ --pool-network   │ │   │
# │  │ - prod   │       │  └────────┘         │   10.255.0.0/16  │ │   │
# │  │          │       │                     │ --nexus-url      │ │   │
# │  └──────────┘       │                     │ --nexus-pool=prod│ │   │
# │                     │                     └──────────────────┘ │   │
# │                     └──────────────────────────────────────────┘   │
# └─────────────────────────────────────────────────────────────────────┘
#
# Flow:
# Phase 1 - Walled Garden:
#   1. Unknown client sends DHCP DISCOVER
#   2. BNG assigns IP from local pool (10.255.x.x - walled garden)
#   3. Client is restricted to captive portal
#
# Phase 2 - Activation:
#   4. Simulate activation (create allocation in Nexus)
#   5. Client triggers DHCP RELEASE + DISCOVER
#   6. BNG recognizes subscriber, calls Nexus
#   7. Client gets real IP from Nexus pool (10.200.x.x)
#
# Verification:
#   - First IP should be 10.255.x.x (walled garden)
#   - After activation, IP should be 10.200.x.x (production)

apiVersion: v1
kind: Namespace
metadata:
  name: demo-walled-garden
---
# Nexus Server with two pools: walled garden and production
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: demo-walled-garden
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexus
  template:
    metadata:
      labels:
        app: nexus
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9002"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: nexus
          image: ghcr.io/codelaboratoryltd/nexus:latest
          args:
            - "serve"
            - "--http-port=9000"
            - "--metrics-port=9002"
          ports:
            - containerPort: 9000
              name: api
            - containerPort: 9002
              name: metrics
          readinessProbe:
            httpGet:
              path: /api/v1/pools
              port: 9000
            initialDelaySeconds: 2
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: nexus
  namespace: demo-walled-garden
spec:
  selector:
    app: nexus
  ports:
    - port: 9000
      targetPort: 9000
      name: api
---
# ConfigMap with test scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: wgar-scripts
  namespace: demo-walled-garden
data:
  setup-pools.sh: |
    #!/bin/sh
    # Create both pools in Nexus
    set -e

    NEXUS_URL="${NEXUS_URL:-http://nexus:9000}"

    echo "Waiting for Nexus..."
    until curl -sf "$NEXUS_URL/api/v1/pools" > /dev/null 2>&1; do
      sleep 2
    done
    echo "Nexus is ready!"

    echo "Creating production pool (10.200.0.0/16)..."
    curl -sf -X POST "$NEXUS_URL/api/v1/pools" \
      -H "Content-Type: application/json" \
      -d '{"id":"prod","cidr":"10.200.0.0/16","prefix":32}' 2>&1 || echo "Pool may exist"

    echo ""
    echo "Pools configured:"
    curl -sf "$NEXUS_URL/api/v1/pools"

  run-wgar-test.sh: |
    #!/bin/sh
    # Walled Garden → Activation → Production IP Test
    #
    # Flow:
    #   1. Unknown subscriber → Walled Garden IP (10.255.x.x)
    #   2. Activate subscriber (create Nexus allocation)
    #   3. Wait for lease expiry
    #   4. Subscriber renews → Production IP (10.200.x.x)

    NEXUS_URL="${NEXUS_URL:-http://nexus:9000}"
    LEASE_TIME=30  # Must match BNG --lease-time

    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║     Walled Garden → Activation → Production IP Test          ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""

    # Get client MAC
    CLIENT_MAC=$(cat /sys/class/net/veth-client/address)
    echo "Client MAC: $CLIENT_MAC"
    echo "Lease Time: ${LEASE_TIME}s"
    echo ""

    # =================================================================
    # Phase 1: Unknown Subscriber → Walled Garden IP
    # =================================================================
    echo "═══ Phase 1: Unknown Subscriber (Walled Garden) ═══"
    echo "Client has no Nexus allocation - should get walled garden IP..."
    echo ""

    ip addr flush dev veth-client 2>/dev/null || true
    timeout 15 udhcpc -i veth-client -n -q -t 5 -T 3 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    WGAR_IP=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "Walled Garden IP: $WGAR_IP"

    PHASE1_PASS=false
    case "$WGAR_IP" in
      10.255.*)
        echo "✓ PASS: Got walled garden IP (10.255.x.x)"
        PHASE1_PASS=true
        ;;
      10.200.*)
        echo "✗ FAIL: Got production IP - subscriber should not be activated yet!"
        ;;
      *)
        echo "? UNEXPECTED: Got $WGAR_IP"
        ;;
    esac
    echo ""

    # =================================================================
    # Phase 2: Activate Subscriber (Create Nexus Allocation)
    # =================================================================
    echo "═══ Phase 2: Activate Subscriber ═══"
    echo "Creating allocation in Nexus for MAC $CLIENT_MAC..."
    echo ""

    # Create allocation in Nexus (simulates RADIUS authentication / activation)
    wget -q -O- --post-data="{\"pool_id\":\"prod\",\"subscriber_id\":\"$CLIENT_MAC\"}" \
      --header="Content-Type: application/json" \
      "$NEXUS_URL/api/v1/allocations" 2>&1 || echo "Allocation may already exist"

    echo ""
    echo "Verifying Nexus allocation..."
    wget -q -O- "$NEXUS_URL/api/v1/allocations/$CLIENT_MAC" 2>&1 || echo "Could not verify"
    echo ""

    # =================================================================
    # Phase 3: Wait for Lease Expiry
    # =================================================================
    echo "═══ Phase 3: Waiting for Lease Expiry ═══"
    echo "Waiting ${LEASE_TIME}s for walled garden lease to expire..."
    echo ""

    # Progress indicator
    for i in $(seq 1 $LEASE_TIME); do
      printf "."
      sleep 1
    done
    echo ""
    echo "Lease expired."
    echo ""

    # =================================================================
    # Phase 4: Renewed Subscriber → Production IP
    # =================================================================
    echo "═══ Phase 4: Activated Subscriber (Production IP) ═══"
    echo "Client now has Nexus allocation - should get production IP..."
    echo ""

    ip addr flush dev veth-client 2>/dev/null || true
    timeout 15 udhcpc -i veth-client -n -q -t 5 -T 3 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    PROD_IP=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "Production IP: $PROD_IP"

    PHASE4_PASS=false
    case "$PROD_IP" in
      10.200.*)
        echo "✓ PASS: Got production IP from Nexus (10.200.x.x)"
        PHASE4_PASS=true
        ;;
      10.255.*)
        echo "✗ FAIL: Still getting walled garden IP"
        ;;
      *)
        echo "? UNEXPECTED: Got $PROD_IP"
        ;;
    esac
    echo ""

    # =================================================================
    # Summary
    # =================================================================
    echo "═══ Summary ═══"
    echo "Phase 1 (Walled Garden): $WGAR_IP"
    echo "Phase 4 (Production):    $PROD_IP"
    echo ""

    if [ "$PHASE1_PASS" = "true" ] && [ "$PHASE4_PASS" = "true" ]; then
      echo "╔══════════════════════════════════════════════════════════════╗"
      echo "║  ✓ SUCCESS: Full Walled Garden → Production Flow Verified!   ║"
      echo "╚══════════════════════════════════════════════════════════════╝"
      echo ""
      echo "  1. Unknown subscriber got walled garden IP (10.255.x.x)"
      echo "  2. Subscriber activated (Nexus allocation created)"
      echo "  3. Lease expired"
      echo "  4. Activated subscriber got production IP (10.200.x.x)"
      exit 0
    else
      echo "╔══════════════════════════════════════════════════════════════╗"
      echo "║  ✗ FAILED: Check BNG and Nexus logs for details              ║"
      echo "╚══════════════════════════════════════════════════════════════╝"
      exit 1
    fi

  udhcpc-script.sh: |
    #!/bin/sh
    case "$1" in
      bound|renew)
        ip addr flush dev $interface 2>/dev/null
        ip addr add $ip/$mask dev $interface
        echo "DHCP: Got IP $ip/$mask on $interface"
        ;;
    esac
---
# BNG + Client Pod
apiVersion: v1
kind: Pod
metadata:
  name: bng-wgar-test
  namespace: demo-walled-garden
  labels:
    app: bng-wgar-test
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
spec:
  shareProcessNamespace: true

  initContainers:
    # Wait for Nexus and create pools
    - name: setup-nexus
      image: curlimages/curl:latest
      command: ["/bin/sh", "/scripts/setup-pools.sh"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true

    # Setup L2 network
    - name: network-setup
      image: nicolaka/netshoot:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          ip link add veth-bng type veth peer name veth-client
          ip addr add 10.255.0.1/16 dev veth-bng
          ip link set veth-bng up
          ip link set veth-client up
          echo "Network ready: veth-bng (10.255.0.1) <-> veth-client"
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]

  containers:
    # BNG with walled garden pool + Nexus for production
    - name: bng
      image: ghcr.io/codelaboratoryltd/bng:latest
      args:
        - "run"
        - "--interface=veth-bng"
        - "--pool-network=10.255.0.0/16"
        - "--pool-gateway=10.255.0.1"
        - "--pool-dns=8.8.8.8"
        - "--nexus-url=http://nexus:9000"
        - "--nexus-pool=prod"
        - "--lease-time=30s"
        
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW", "SYS_ADMIN"]

    # Test client
    - name: client
      image: alpine:3.19
      command: ["sleep", "infinity"]
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true

  volumes:
    - name: scripts
      configMap:
        name: wgar-scripts
        defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: bng-wgar-test
  namespace: demo-walled-garden
spec:
  selector:
    app: bng-wgar-test
  ports:
    - port: 9090
      targetPort: 9090
      name: metrics
