# HA with Nexus Demo
# Demonstrates: Two BNGs sharing state via central Nexus
#
# Architecture:
# ┌─────────────────────────────────────────────────────────────────┐
# │                    demo-ha-nexus namespace                       │
# │                                                                  │
# │                      ┌──────────┐                                │
# │                      │  Nexus   │                                │
# │                      │ (shared  │                                │
# │                      │  state)  │                                │
# │                      └────┬─────┘                                │
# │                           │                                      │
# │              ┌────────────┴────────────┐                        │
# │              │                         │                        │
# │        ┌─────▼─────┐             ┌─────▼─────┐                  │
# │        │   BNG-1   │             │   BNG-2   │                  │
# │        │ (active)  │             │ (standby) │                  │
# │        └─────┬─────┘             └─────┬─────┘                  │
# │              │                         │                        │
# │         [veth-bng1]               [veth-bng2]                   │
# │              │                         │                        │
# │        ┌─────▼─────┐             ┌─────▼─────┐                  │
# │        │  Client1  │             │  Client2  │                  │
# │        └───────────┘             └───────────┘                  │
# └─────────────────────────────────────────────────────────────────┘
#
# HA Behavior:
#   - Both BNGs lookup allocations from same Nexus
#   - Client can get same IP from either BNG
#   - If BNG-1 fails, client's next DHCP goes to BNG-2
#   - BNG-2 returns same IP (from Nexus lookup)

apiVersion: v1
kind: Namespace
metadata:
  name: demo-ha-nexus
---
# Shared Nexus for both BNGs
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: demo-ha-nexus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nexus
  template:
    metadata:
      labels:
        app: nexus
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9002"
    spec:
      containers:
        - name: nexus
          image: ghcr.io/codelaboratoryltd/nexus:latest
          args:
            - "serve"
            - "--http-port=9000"
            - "--metrics-port=9002"
          ports:
            - containerPort: 9000
              name: api
            - containerPort: 9002
              name: metrics
          readinessProbe:
            httpGet:
              path: /api/v1/pools
              port: 9000
            initialDelaySeconds: 2
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: nexus
  namespace: demo-ha-nexus
spec:
  selector:
    app: nexus
  ports:
    - port: 9000
      targetPort: 9000
      name: api
---
# ConfigMap with test scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: ha-scripts
  namespace: demo-ha-nexus
data:
  setup-pool.sh: |
    #!/bin/sh
    set -e
    NEXUS_URL="${NEXUS_URL:-http://nexus:9000}"

    echo "Waiting for Nexus..."
    until curl -sf "$NEXUS_URL/api/v1/pools" > /dev/null 2>&1; do
      sleep 2
    done
    echo "Nexus is ready!"

    echo "Creating HA pool (10.200.0.0/16)..."
    curl -sf -X POST "$NEXUS_URL/api/v1/pools" \
      -H "Content-Type: application/json" \
      -d '{"id":"ha-pool","cidr":"10.200.0.0/16","prefix":32}' 2>&1 || echo "Pool may exist"

    echo ""
    echo "Pool configured:"
    curl -sf "$NEXUS_URL/api/v1/pools"

  run-ha-test.sh: |
    #!/bin/sh
    # HA Failover Test
    # Demonstrates: Same IP returned from either BNG via Nexus

    NEXUS_URL="${NEXUS_URL:-http://nexus:9000}"

    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║           HA with Nexus - Failover Test                      ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""

    # Get client MAC
    CLIENT_MAC=$(cat /sys/class/net/veth-client/address)
    echo "Client MAC: $CLIENT_MAC"
    echo ""

    # =================================================================
    # Phase 1: Get IP from BNG-1 (Primary)
    # =================================================================
    echo "═══ Phase 1: Request from BNG-1 ═══"
    echo "Getting IP via DHCP from BNG-1..."

    ip addr flush dev veth-client 2>/dev/null || true
    timeout 15 udhcpc -i veth-client -n -q -t 5 -T 3 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    IP1=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "IP from BNG-1: $IP1"

    # Activate subscriber in Nexus
    echo ""
    echo "Activating subscriber in Nexus..."
    wget -q -O- --post-data="{\"pool_id\":\"ha-pool\",\"subscriber_id\":\"$CLIENT_MAC\"}" \
      --header="Content-Type: application/json" \
      "$NEXUS_URL/api/v1/allocations" 2>&1 || echo "May already exist"

    # Get allocated IP from Nexus
    NEXUS_IP=$(wget -q -O- "$NEXUS_URL/api/v1/allocations/$CLIENT_MAC" 2>&1 | grep -o '"ip":"[^"]*"' | cut -d'"' -f4)
    echo "Nexus allocated IP: $NEXUS_IP"
    echo ""

    # =================================================================
    # Phase 2: Simulate failover - request from BNG-2
    # =================================================================
    echo "═══ Phase 2: Simulate Failover to BNG-2 ═══"
    echo "Releasing IP and requesting from BNG-2..."
    echo "(In real failover, client would automatically go to BNG-2)"
    echo ""

    # Release and get new IP (would come from BNG-2 in real setup)
    ip addr flush dev veth-client 2>/dev/null || true
    sleep 2
    timeout 15 udhcpc -i veth-client -n -q -t 5 -T 3 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    IP2=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "IP after 'failover': $IP2"
    echo ""

    # =================================================================
    # Summary
    # =================================================================
    echo "═══ Summary ═══"
    echo "Nexus Allocated: $NEXUS_IP"
    echo "IP from BNG-1:   $IP1"
    echo "IP after failover: $IP2"
    echo ""

    if [ "$NEXUS_IP" = "$IP2" ]; then
      echo "╔══════════════════════════════════════════════════════════════╗"
      echo "║  ✓ SUCCESS: Same IP returned after failover!                 ║"
      echo "╚══════════════════════════════════════════════════════════════╝"
      echo ""
      echo "  - Nexus is the source of truth"
      echo "  - Any BNG can serve the same subscriber"
      echo "  - Failover is automatic via shared state"
    else
      echo "! IPs differ - check BNG and Nexus logs"
    fi

  udhcpc-script.sh: |
    #!/bin/sh
    case "$1" in
      bound|renew)
        ip addr flush dev $interface 2>/dev/null
        ip addr add $ip/$mask dev $interface
        echo "DHCP: Got IP $ip/$mask on $interface"
        ;;
    esac
---
# BNG + Client Pod (simplified single-pod test)
apiVersion: v1
kind: Pod
metadata:
  name: bng-ha-test
  namespace: demo-ha-nexus
  labels:
    app: bng-ha-test
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  shareProcessNamespace: true

  initContainers:
    - name: setup-nexus
      image: curlimages/curl:latest
      command: ["/bin/sh", "/scripts/setup-pool.sh"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true

    - name: network-setup
      image: nicolaka/netshoot:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          ip link add veth-bng type veth peer name veth-client
          ip addr add 10.200.0.1/16 dev veth-bng
          ip link set veth-bng up
          ip link set veth-client up
          echo "Network ready: veth-bng <-> veth-client"
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]

  containers:
    - name: bng
      image: ghcr.io/codelaboratoryltd/bng:latest
      args:
        - "run"
        - "--interface=veth-bng"
        - "--pool-network=10.200.0.0/16"
        - "--pool-gateway=10.200.0.1"
        - "--pool-dns=8.8.8.8"
        - "--nexus-url=http://nexus:9000"
        - "--nexus-pool=ha-pool"
        - "--lease-time=5m"
        
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW", "SYS_ADMIN"]

    - name: client
      image: alpine:3.19
      command: ["sleep", "infinity"]
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true

  volumes:
    - name: scripts
      configMap:
        name: ha-scripts
        defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: bng-ha-test
  namespace: demo-ha-nexus
spec:
  selector:
    app: bng-ha-test
  ports:
    - port: 9090
      targetPort: 9090
      name: metrics
