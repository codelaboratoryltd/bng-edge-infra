# WiFi Demo (TTL-Based Lease Mode)
# Demonstrates: Epoch-based IP allocation with automatic expiration
#
# Architecture:
# ┌─────────────────────────────────────────────────────────────────┐
# │                     demo-wifi namespace                          │
# │                                                                  │
# │  ┌─────────┐       ┌─────────────┐                              │
# │  │  Nexus  │◄─────►│     BNG     │                              │
# │  │ (state) │       │ (lease mode)│                              │
# │  │         │       │             │                              │
# │  │ epoch:  │       │ --pool-mode │                              │
# │  │ tracking│       │   lease     │                              │
# │  └─────────┘       └──────┬──────┘                              │
# │                           │                                      │
# │                      [veth-bng]                                  │
# │                           │                                      │
# │                    ┌──────▼──────┐                              │
# │                    │   Client    │                              │
# │                    │  (WiFi sim) │                              │
# │                    └─────────────┘                              │
# └─────────────────────────────────────────────────────────────────┘
#
# Lease Mode Behavior:
#   - IPs allocated with epoch timestamp
#   - Epoch advances periodically (demo: every 30s)
#   - Allocations expire after grace period (1 epoch)
#   - Renewals update epoch to extend lease
#   - Memory efficient: 2 bits per IP (16KB for /16)

apiVersion: v1
kind: Namespace
metadata:
  name: demo-wifi
---
# ConfigMap with test scripts
apiVersion: v1
kind: ConfigMap
metadata:
  name: wifi-scripts
  namespace: demo-wifi
data:
  run-wifi-test.sh: |
    #!/bin/sh
    # WiFi Lease Mode Test
    # Demonstrates: TTL-based allocation with epoch expiration

    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║         WiFi Demo - TTL-Based Lease Expiration               ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""

    # Get client MAC
    CLIENT_MAC=$(cat /sys/class/net/veth-client/address)
    echo "Client MAC: $CLIENT_MAC"
    echo ""

    # =================================================================
    # Phase 1: Initial DHCP Allocation
    # =================================================================
    echo "═══ Phase 1: Get Initial Lease ═══"
    echo "Requesting IP via DHCP (lease mode)..."

    ip addr flush dev veth-client 2>/dev/null || true
    timeout 15 udhcpc -i veth-client -n -q -t 5 -T 3 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    IP1=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "Initial IP: $IP1"

    # Check epoch in allocation
    echo ""
    echo "Checking allocation epoch..."
    ALLOC_INFO=$(wget -q -O- "http://bng-wifi:8080/api/v1/sessions" 2>&1 || echo "{}")
    echo "Sessions: $ALLOC_INFO"
    echo ""

    # =================================================================
    # Phase 2: Check Current Epoch
    # =================================================================
    echo "═══ Phase 2: Check Epoch State ═══"
    echo "Getting allocator stats from BNG..."

    STATS=$(wget -q -O- "http://bng-wifi:8080/api/v1/stats" 2>&1 || echo "{}")
    echo "Stats: $STATS"
    echo ""

    # =================================================================
    # Phase 3: Simulate Lease Renewal
    # =================================================================
    echo "═══ Phase 3: Lease Renewal ═══"
    echo "Waiting 5 seconds then renewing lease..."
    sleep 5

    # Force a renewal by running udhcpc again with the same interface
    timeout 10 udhcpc -i veth-client -n -q -t 3 -T 2 -f -s /scripts/udhcpc-script.sh 2>&1 || true

    IP2=$(ip addr show veth-client 2>/dev/null | grep "inet " | head -1 | awk '{print $2}' | cut -d/ -f1)
    echo ""
    echo "After renewal: $IP2"

    # =================================================================
    # Phase 4: Verify Lease Stability
    # =================================================================
    echo ""
    echo "═══ Phase 4: Lease Stability Check ═══"

    if [ "$IP1" = "$IP2" ]; then
      echo "✓ Same IP after renewal (sticky allocation working)"
    else
      echo "! Different IP after renewal: $IP1 → $IP2"
    fi

    # =================================================================
    # Phase 5: Check Pool Utilization
    # =================================================================
    echo ""
    echo "═══ Phase 5: Pool Utilization ═══"

    POOL_STATS=$(wget -q -O- "http://nexus:9000/api/v1/pools/wifi-pool" 2>&1 || echo "Could not query pool")
    echo "Pool info: $POOL_STATS"
    echo ""

    # =================================================================
    # Summary
    # =================================================================
    echo "═══ Summary ═══"
    echo "Client MAC: $CLIENT_MAC"
    echo "Initial IP: $IP1"
    echo "After Renewal: $IP2"
    echo ""

    if [ -n "$IP1" ] && [ "$IP1" = "$IP2" ]; then
      echo "╔══════════════════════════════════════════════════════════════╗"
      echo "║  ✓ SUCCESS: WiFi lease mode working correctly                ║"
      echo "╚══════════════════════════════════════════════════════════════╝"
      echo ""
      echo "  - Lease allocated with epoch timestamp"
      echo "  - Renewal extended lease (same IP)"
      echo "  - Memory efficient: 2 bits per IP"
      echo ""
      echo "  Epoch-based expiration:"
      echo "  - Epoch advances periodically"
      echo "  - Stale leases expire automatically"
      echo "  - No background reaper needed (lazy cleanup)"
    else
      echo "! Test did not complete as expected"
    fi

  udhcpc-script.sh: |
    #!/bin/sh
    case "$1" in
      bound|renew)
        ip addr flush dev $interface 2>/dev/null
        ip addr add $ip/$mask dev $interface
        echo "DHCP: Got IP $ip/$mask on $interface"
        ;;
    esac
---
# Nexus for distributed state
apiVersion: v1
kind: Pod
metadata:
  name: nexus
  namespace: demo-wifi
  labels:
    app: nexus
spec:
  containers:
    - name: nexus
      image: ghcr.io/codelaboratoryltd/nexus:latest
      args:
        - "serve"
        - "--http-port=9000"
        
        
      ports:
        - containerPort: 9000
          name: api
      readinessProbe:
        httpGet:
          path: /health
          port: 9000
        initialDelaySeconds: 2
        periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: nexus
  namespace: demo-wifi
spec:
  selector:
    app: nexus
  ports:
    - port: 9000
      targetPort: 9000
      name: api
---
# BNG in lease mode
apiVersion: v1
kind: Pod
metadata:
  name: bng-wifi
  namespace: demo-wifi
  labels:
    app: bng-wifi
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  shareProcessNamespace: true

  initContainers:
    # Wait for Nexus to be ready
    - name: wait-nexus
      image: busybox:1.36
      command: ["sh", "-c"]
      args:
        - |
          echo "Waiting for Nexus..."
          until wget -q -O- http://nexus:9000/health >/dev/null 2>&1; do
            sleep 1
          done
          echo "Nexus is ready"

    # Create pool in Nexus
    - name: create-pool
      image: busybox:1.36
      command: ["sh", "-c"]
      args:
        - |
          echo "Creating WiFi pool in Nexus..."
          wget -q -O- --post-data='{"id":"wifi-pool","cidr":"10.200.0.0/16","prefix":32}' \
            --header='Content-Type: application/json' \
            http://nexus:9000/api/v1/pools || true
          echo "Pool created"

    # Setup network
    - name: network-setup
      image: nicolaka/netshoot:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          ip link add veth-bng type veth peer name veth-client
          ip addr add 10.200.0.1/16 dev veth-bng
          ip link set veth-bng up
          ip link set veth-client up
          echo "Network ready: veth-bng (10.200.0.1) <-> veth-client"
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]

  containers:
    - name: bng
      image: ghcr.io/codelaboratoryltd/bng:latest
      args:
        - "run"
        - "--interface=veth-bng"
        - "--pool-network=10.200.0.0/16"
        - "--pool-gateway=10.200.0.1"
        - "--pool-dns=8.8.8.8"
        # TTL/Epoch lease mode for WiFi (Issue #66)
        - "--pool-mode=lease"
        - "--epoch-period=30s"
        - "--epoch-grace=1"
        - "--nexus-url=http://nexus:9000"
        - "--nexus-pool=wifi-pool"
        - "--lease-time=2m"
        
      env:
        - name: BNG_EPOCH_PERIOD
          value: "30s"  # Short epoch for demo
      ports:
        - containerPort: 8080
          name: api
        - containerPort: 9090
          name: metrics
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW", "SYS_ADMIN"]

    - name: client
      image: alpine:3.19
      command: ["sleep", "infinity"]
      securityContext:
        privileged: true
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true

  volumes:
    - name: scripts
      configMap:
        name: wifi-scripts
        defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: bng-wifi
  namespace: demo-wifi
spec:
  selector:
    app: bng-wifi
  ports:
    - port: 8080
      targetPort: 8080
      name: api
    - port: 9090
      targetPort: 9090
      name: metrics
