# CI/CD Pipeline for BNG Edge Infrastructure
# Runs on all pull requests and pushes to main
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.23"

jobs:
  # ===========================================================================
  # BNG Tests - Run tests for the BNG submodule
  # ===========================================================================
  bng-test:
    name: BNG Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/bng
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/bng/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: src/bng/coverage.out
          flags: bng
          name: bng-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Build BNG binary
        run: go build -v -o bin/bng ./cmd/bng

  # ===========================================================================
  # Nexus Tests - Run tests for the Nexus submodule
  # ===========================================================================
  nexus-test:
    name: Nexus Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/nexus
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: src/nexus/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: src/nexus/coverage.out
          flags: nexus
          name: nexus-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Build Nexus binary
        run: go build -v -o bin/nexus ./cmd/nexus

  # ===========================================================================
  # eBPF Build Verification - Verify eBPF programs compile correctly
  # ===========================================================================
  ebpf-build:
    name: eBPF Build Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install eBPF build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            llvm \
            libbpf-dev \
            linux-headers-generic \
            linux-tools-generic

      - name: Build eBPF programs
        working-directory: src/bng/bpf
        run: make

      - name: Verify eBPF objects
        working-directory: src/bng/bpf
        run: |
          echo "Verifying eBPF object files..."
          for obj in *.bpf.o; do
            if [ -f "$obj" ]; then
              echo "Checking $obj..."
              file "$obj"
              # Check that it's a valid ELF file for BPF
              file "$obj" | grep -q "ELF" || (echo "ERROR: $obj is not a valid ELF file" && exit 1)
            fi
          done
          echo "All eBPF programs compiled successfully"

  # ===========================================================================
  # Lint - Run linters on Go code
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint on BNG
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: src/bng
          args: --timeout=5m

      - name: Run golangci-lint on Nexus
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: src/nexus
          args: --timeout=5m

  # ===========================================================================
  # Security Scanning - Check for security vulnerabilities
  # ===========================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install security tools
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run gosec on BNG
        working-directory: src/bng
        run: gosec -severity medium -confidence medium -fmt sarif -out gosec-bng.sarif ./... || true
        continue-on-error: true

      - name: Run gosec on Nexus
        working-directory: src/nexus
        run: gosec -severity medium -confidence medium -fmt sarif -out gosec-nexus.sarif ./... || true
        continue-on-error: true

      - name: Run govulncheck on BNG
        working-directory: src/bng
        run: govulncheck ./...
        continue-on-error: true

      - name: Run govulncheck on Nexus
        working-directory: src/nexus
        run: govulncheck ./...
        continue-on-error: true

      - name: Upload gosec results (BNG)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: src/bng/gosec-bng.sarif
          category: gosec-bng
        continue-on-error: true

      - name: Upload gosec results (Nexus)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: src/nexus/gosec-nexus.sarif
          category: gosec-nexus
        continue-on-error: true

  # ===========================================================================
  # Build Verification - Ensure Docker images can be built
  # ===========================================================================
  build-docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [bng-test, nexus-test, ebpf-build]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build BNG Docker image
        uses: docker/build-push-action@v6
        with:
          context: src/bng
          push: false
          tags: ghcr.io/codelaboratoryltd/bng:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
        if: hashFiles('src/bng/Dockerfile') != ''

  # ===========================================================================
  # Summary - Final status check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [bng-test, nexus-test, ebpf-build, lint, security]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.bng-test.result }}" == "failure" ]] || \
             [[ "${{ needs.nexus-test.result }}" == "failure" ]] || \
             [[ "${{ needs.ebpf-build.result }}" == "failure" ]] || \
             [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "One or more required jobs failed"
            exit 1
          fi
          echo "All required CI checks passed!"
