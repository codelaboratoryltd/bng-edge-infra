# Containerlab BNG Integration Test
# Deploys the bng01 topology using containerlab and runs BNG Blaster
# to simulate 10 IPoE/DHCP subscribers against the BNG.
name: Containerlab BNG Integration

on:
  push:
    branches: [main]
    paths:
      - "src/bng/**"
      - "tests/containerlab-bng01/**"
      - ".github/workflows/containerlab-integration.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/bng/**"
      - "tests/containerlab-bng01/**"
      - ".github/workflows/containerlab-integration.yml"
  workflow_dispatch:

env:
  CLAB_VERSION: "0.69.3"
  BNG_IMAGE: "ghcr.io/codelaboratoryltd/bng:ci"
  BLASTER_IMAGE: "bngblaster:ci"
  LAB_DIR: "tests/containerlab-bng01"

jobs:
  # ===========================================================================
  # Containerlab BNG Integration Test
  # ===========================================================================
  containerlab-bng:
    name: BNG Blaster 10-subscriber test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build BNG image
        uses: docker/build-push-action@v6
        with:
          context: src/bng
          push: false
          load: true
          tags: ${{ env.BNG_IMAGE }}
          cache-from: type=gha,scope=clab-bng
          cache-to: type=gha,scope=clab-bng,mode=max

      - name: Build BNG Blaster image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.LAB_DIR }}/subscribers
          push: false
          load: true
          tags: ${{ env.BLASTER_IMAGE }}
          cache-from: type=gha,scope=clab-blaster
          cache-to: type=gha,scope=clab-blaster,mode=max

      - name: Install containerlab
        run: |
          bash -c "$(curl -sL https://get.containerlab.dev)" -- -v ${{ env.CLAB_VERSION }}
          clab version

      - name: Deploy lab
        working-directory: ${{ env.LAB_DIR }}
        run: |
          sudo clab deploy -t bng01.clab.yml --reconfigure
          echo ""
          echo "=== Lab nodes ==="
          sudo clab inspect -t bng01.clab.yml

      - name: Wait for BNG health
        run: |
          echo "Waiting for BNG to start..."
          BNG_CONTAINER="clab-bng01-bng1"
          MAX_RETRIES=30
          RETRY_INTERVAL=2

          for i in $(seq 1 $MAX_RETRIES); do
            if docker exec "$BNG_CONTAINER" wget -q -O- http://127.0.0.1:9090/health 2>/dev/null | grep -q "ok"; then
              echo "BNG health check passed (attempt $i)"
              break
            fi
            if [ "$i" -eq "$MAX_RETRIES" ]; then
              echo "ERROR: BNG failed to become healthy after $((MAX_RETRIES * RETRY_INTERVAL))s"
              echo ""
              echo "=== BNG container logs ==="
              docker logs "$BNG_CONTAINER" --tail=50
              exit 1
            fi
            echo "  Attempt $i/$MAX_RETRIES - waiting ${RETRY_INTERVAL}s..."
            sleep "$RETRY_INTERVAL"
          done

      - name: Run BNG Blaster
        id: blaster
        run: |
          echo "=== Running BNG Blaster (10 IPoE/DHCP subscribers) ==="
          echo ""

          SUBSCRIBER_CONTAINER="clab-bng01-subscribers"

          # Run blaster with DHCP logging for 60s then terminate
          docker exec "$SUBSCRIBER_CONTAINER" \
            sh -c 'timeout 60 bngblaster -C /config/config.json -l dhcp -b -J /tmp/report.json; true' \
            2>&1 | tee /tmp/blaster-output.txt

          echo ""
          echo "=== BNG Blaster output ==="
          cat /tmp/blaster-output.txt

      - name: Parse results
        id: results
        run: |
          echo "=== Parsing BNG Blaster results ==="
          echo ""

          # Primary check: BNG Blaster prints this when all sessions are up
          if grep -q 'ALL SESSIONS ESTABLISHED' /tmp/blaster-output.txt 2>/dev/null; then
            ALL_UP="true"
          else
            ALL_UP="false"
          fi

          # Extract session counts from report
          ESTABLISHED=$(grep -oP 'Sessions established: \K\d+' /tmp/blaster-output.txt 2>/dev/null | tail -1 || echo "0")
          DHCP_TX=$(grep -oP 'DHCP\s+TX:\s*\K\d+' /tmp/blaster-output.txt 2>/dev/null | tail -1 || echo "0")
          DHCP_RX=$(grep -oP 'DHCP\s+RX:\s*\K\d+' /tmp/blaster-output.txt 2>/dev/null | tail -1 || echo "0")
          DHCP_TIMEOUTS=$(grep -oP 'DHCP Request:\s*\K\d+' /tmp/blaster-output.txt 2>/dev/null | tail -1 || echo "0")

          echo "Sessions established: $ESTABLISHED/10"
          echo "DHCP TX: $DHCP_TX  RX: $DHCP_RX  Timeouts: $DHCP_TIMEOUTS"
          echo "established=$ESTABLISHED" >> $GITHUB_OUTPUT
          echo "dhcp_tx=$DHCP_TX" >> $GITHUB_OUTPUT
          echo "dhcp_rx=$DHCP_RX" >> $GITHUB_OUTPUT

          # Success = all 10 sessions established (DHCP + ARP resolution)
          # DHCP RX >= 20 means 10 Offers + 10 ACKs (all 10 DORA cycles completed)
          if [ "$ALL_UP" = "true" ] && [ "$ESTABLISHED" -ge 10 ]; then
            echo ""
            echo "PASS: All 10 sessions established"
            echo "pass=true" >> $GITHUB_OUTPUT
          elif [ "$DHCP_RX" -ge 20 ]; then
            echo ""
            echo "PASS: All 10 DHCP DORA cycles completed (RX=$DHCP_RX, $ESTABLISHED sessions established)"
            echo "pass=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "FAIL: Expected 10 sessions, got $ESTABLISHED established (DHCP RX=$DHCP_RX)"
            echo "pass=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run BNG Blaster (fast path)
        id: fastpath
        run: |
          echo "=== Running BNG Blaster - Fast Path Run (same 10 MACs) ==="
          echo ""
          echo "After run 1, the slow path populated the eBPF subscriber_pools map."
          echo "Run 2 should hit the XDP fast path for cached subscribers."
          echo ""

          SUBSCRIBER_CONTAINER="clab-bng01-subscribers"

          # Remove lock file from first run
          docker exec "$SUBSCRIBER_CONTAINER" rm -f /run/lock/bngblaster_eth1.lock 2>/dev/null || true

          # Small delay to let BNG stabilize after first run
          sleep 2

          # Run blaster again with same config (same 10 MACs)
          docker exec "$SUBSCRIBER_CONTAINER" \
            sh -c 'timeout 60 bngblaster -C /config/config.json -l dhcp -b -J /tmp/report2.json; true' \
            2>&1 | tee /tmp/blaster-output-fp.txt

          echo ""
          echo "=== Fast Path BNG Blaster output ==="
          cat /tmp/blaster-output-fp.txt

          # Parse fast path run results
          if grep -q 'ALL SESSIONS ESTABLISHED' /tmp/blaster-output-fp.txt 2>/dev/null; then
            FP_ALL_UP="true"
          else
            FP_ALL_UP="false"
          fi

          FP_ESTABLISHED=$(grep -oP 'Sessions established: \K\d+' /tmp/blaster-output-fp.txt 2>/dev/null | tail -1 || echo "0")
          FP_DHCP_TX=$(grep -oP 'DHCP\s+TX:\s*\K\d+' /tmp/blaster-output-fp.txt 2>/dev/null | tail -1 || echo "0")
          FP_DHCP_RX=$(grep -oP 'DHCP\s+RX:\s*\K\d+' /tmp/blaster-output-fp.txt 2>/dev/null | tail -1 || echo "0")

          echo ""
          echo "Fast path run: Sessions=$FP_ESTABLISHED/10  TX=$FP_DHCP_TX  RX=$FP_DHCP_RX"
          echo "fp_established=$FP_ESTABLISHED" >> $GITHUB_OUTPUT
          echo "fp_dhcp_tx=$FP_DHCP_TX" >> $GITHUB_OUTPUT
          echo "fp_dhcp_rx=$FP_DHCP_RX" >> $GITHUB_OUTPUT

          if [ "$FP_ALL_UP" = "true" ] && [ "$FP_ESTABLISHED" -ge 10 ]; then
            echo "PASS: All 10 fast path sessions established"
            echo "fp_pass=true" >> $GITHUB_OUTPUT
          elif [ "$FP_DHCP_RX" -ge 20 ]; then
            echo "PASS: All 10 fast path DORA cycles completed (RX=$FP_DHCP_RX)"
            echo "fp_pass=true" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "WARN: Fast path run got $FP_ESTABLISHED sessions (DHCP RX=$FP_DHCP_RX)"
            echo "This is expected on CI with xdpgeneric mode - XDP_TX may not deliver via veth."
            echo "fp_pass=warn" >> $GITHUB_OUTPUT
          fi

      - name: Check BNG metrics
        id: metrics
        run: |
          echo "=== BNG Metrics ==="
          echo ""

          BNG_CONTAINER="clab-bng01-bng1"

          # Scrape all metrics
          METRICS=$(docker exec "$BNG_CONTAINER" \
            wget -q -O- http://127.0.0.1:9090/metrics 2>/dev/null || echo "")

          if [ -z "$METRICS" ]; then
            echo "WARNING: Could not scrape metrics endpoint"
            echo "active_leases=0" >> $GITHUB_OUTPUT
            echo "fp_hits=0" >> $GITHUB_OUTPUT
            echo "fp_misses=0" >> $GITHUB_OUTPUT
            echo "pool_allocated=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract key counters
          ACTIVE_LEASES=$(echo "$METRICS" | grep -oP '^bng_dhcp_active_leases\s+\K[0-9.]+' || echo "0")
          FP_HITS=$(echo "$METRICS" | grep -oP '^bng_ebpf_fastpath_hits_total\s+\K[0-9.]+' || echo "0")
          FP_MISSES=$(echo "$METRICS" | grep -oP '^bng_ebpf_fastpath_misses_total\s+\K[0-9.]+' || echo "0")
          POOL_ALLOCATED=$(echo "$METRICS" | grep -oP '^bng_pool_allocated_ips\s+\K[0-9.]+' || echo "0")

          echo "Active leases:      $ACTIVE_LEASES"
          echo "Fast path hits:     $FP_HITS"
          echo "Fast path misses:   $FP_MISSES"
          echo "Pool allocated IPs: $POOL_ALLOCATED"

          echo "active_leases=$ACTIVE_LEASES" >> $GITHUB_OUTPUT
          echo "fp_hits=$FP_HITS" >> $GITHUB_OUTPUT
          echo "fp_misses=$FP_MISSES" >> $GITHUB_OUTPUT
          echo "pool_allocated=$POOL_ALLOCATED" >> $GITHUB_OUTPUT

          echo ""
          echo "All DHCP metrics:"
          echo "$METRICS" | grep -E "^(dhcp_|bng_dhcp|bng_ebpf|bng_pool|bng_active)" || echo "  (none found)"

          # Fast path hits > 0 is informational (xdpgeneric on veth may not deliver XDP_TX)
          if [ "${FP_HITS%.*}" -gt 0 ] 2>/dev/null; then
            echo ""
            echo "Fast path hits detected - eBPF XDP fast path is working!"
          else
            echo ""
            echo "NOTE: No fast path hits detected. This is expected on CI with xdpgeneric/veth."
            echo "The eBPF program runs but XDP_TX replies may not be delivered back through veth pairs."
          fi

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== BNG container logs ==="
          docker logs clab-bng01-bng1 --tail=200 2>&1 || true

          echo ""
          echo "=== FRR container logs ==="
          docker logs clab-bng01-corerouter1 --tail=50 2>&1 || true

          echo ""
          echo "=== Subscriber container logs ==="
          docker logs clab-bng01-subscribers --tail=50 2>&1 || true

          echo ""
          echo "=== BNG interfaces ==="
          docker exec clab-bng01-bng1 ip addr 2>/dev/null || true

          echo ""
          echo "=== BNG routes ==="
          docker exec clab-bng01-bng1 ip route 2>/dev/null || true

          echo ""
          echo "=== Docker network ==="
          docker network ls 2>/dev/null || true

      - name: Generate report
        if: always()
        run: |
          echo "## Containerlab BNG Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Topology" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "subscribers (BNG Blaster) --eth1-- bng1 --eth2-- corerouter1 (FRR)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Slow Path (Run 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sessions established | ${{ steps.results.outputs.established || '—' }}/10 |" >> $GITHUB_STEP_SUMMARY
          echo "| DHCP TX / RX | ${{ steps.results.outputs.dhcp_tx || '—' }} / ${{ steps.results.outputs.dhcp_rx || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${{ steps.results.outputs.pass == 'true' && '✅ Pass' || '❌ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fast Path (Run 2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sessions established | ${{ steps.fastpath.outputs.fp_established || '—' }}/10 |" >> $GITHUB_STEP_SUMMARY
          echo "| DHCP TX / RX | ${{ steps.fastpath.outputs.fp_dhcp_tx || '—' }} / ${{ steps.fastpath.outputs.fp_dhcp_rx || '—' }} |" >> $GITHUB_STEP_SUMMARY
          FP_RESULT="${{ steps.fastpath.outputs.fp_pass || 'unknown' }}"
          if [ "$FP_RESULT" = "true" ]; then
            echo "| Result | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FP_RESULT" = "warn" ]; then
            echo "| Result | ⚠️ Expected on CI (xdpgeneric) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Result | ❌ Check logs |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### BNG Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Active leases | ${{ steps.metrics.outputs.active_leases || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| eBPF fast path hits | ${{ steps.metrics.outputs.fp_hits || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| eBPF fast path misses | ${{ steps.metrics.outputs.fp_misses || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pool allocated IPs | ${{ steps.metrics.outputs.pool_allocated || '—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Containerlab | v${{ env.CLAB_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| BNG image | \`${{ env.BNG_IMAGE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pool | 10.0.1.0/24 |" >> $GITHUB_STEP_SUMMARY
          echo "| Subscriber count | 10 |" >> $GITHUB_STEP_SUMMARY
          echo "| Session start rate | 2/sec |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        working-directory: ${{ env.LAB_DIR }}
        run: |
          sudo clab destroy -t bng01.clab.yml --cleanup || true
